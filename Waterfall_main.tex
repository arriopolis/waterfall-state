\documentclass{article}
%\usepackage[T1]{fontenc}
\usepackage{amsmath}
\usepackage{fancyhdr}
\usepackage{amssymb}
\usepackage{amsthm}
\usepackage{graphicx}
\usepackage{varioref}
\usepackage{verbatim} 
\usepackage{multicol}
\usepackage{enumerate}

\usepackage{mathtools}
%\usepackage[normalem]{ulem}

\usepackage{caption}
\usepackage{subcaption}
%\usepackage[T1]{fontenc}
\usepackage[margin=1in]{geometry}
\usepackage{qcircuit}

%\usepackage{mathrsfs}

\usepackage{url}\urlstyle{same}
\usepackage{xspace}
\usepackage{thm-restate}

% Nicer font
%\usepackage{mathpazo}

% Microtype
\usepackage{microtype}

% TikZ
\usepackage{tikz}
\usetikzlibrary{decorations.pathreplacing}
\usetikzlibrary{calc}

% Support eps figures
\usepackage{epstopdf}

% Hypertext package
\usepackage[colorlinks = true]{hyperref}
% Title and authors
%\hypersetup{
%  pdftitle = {},
%  pdfauthor = {}
%}
% Color definitions
\usepackage{xcolor}
\definecolor{darkred}  {rgb}{0.5,0,0}
\definecolor{darkblue} {rgb}{0,0,0.5}
\definecolor{darkgreen}{rgb}{0,0.5,0}
% Color links
\hypersetup{
  urlcolor   = blue,         % color of external links
  linkcolor  = darkblue,     % color of internal links
  citecolor  = darkgreen,    % color of links to bibliography
  filecolor  = darkred       % color of file links
}

% Clever references
\usepackage{cleveref}%[nameinlink]
\crefname{lemma}{Lemma}{Lemmas}
\crefname{proposition}{Proposition}{Propositions}
\crefname{definition}{Definition}{Definitions}
\crefname{theorem}{Theorem}{Theorems}
\crefname{conjecture}{Conjecture}{Conjectures}
\crefname{corollary}{Corollary}{Corollaries}
\crefname{section}{Section}{Sections}
\crefname{appendix}{Appendix}{Appendices}
\crefname{figure}{Fig.}{Figs.}
\crefname{equation}{Eq.}{Eqs.}
\crefname{table}{Table}{Tables}
\crefname{claim}{Claim}{Claims}


%%%%%%%%%%%%%%%%%%%%%%%%%
%  N E W T H E O R E M  %
%%%%%%%%%%%%%%%%%%%%%%%%%

\newtheorem{theorem}{Theorem}
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{definition}[theorem]{Definition}
\newtheorem{corollary}[theorem]{Corollary}
\newtheorem{conjecture}[theorem]{Conjecture}
\newtheorem*{conjecture*}{Conjecture}
\newtheorem*{problem}{Problem}
\newtheorem{claim}[theorem]{Claim}
\theoremstyle{definition}
\newtheorem*{remark}{Remark}
\newtheorem*{example}{Example}


%%%%%%%%%%%%%%%%%%%
%  Comments  %
%%%%%%%%%%%%%%%%%%%
\newcommand{\todo}[1]{{\color{red}{[{\bf TODO:} #1]}}}
\newcommand{\tocite}[1]{{\color{blue}{[{\bf CITE:}#1]}}}
\newcommand{\tocheck}[1]{{\color{red}{[{\bf TO CHECK:}#1]}}}

%%%%%%%%%%%%%%%%%%%
%  Author Affiliations  %
%%%%%%%%%%%%%%%%%%%
%\usepackage{authblk}
%\renewcommand\Authfont{\scshape}
%\renewcommand\Affilfont{\itshape\small}


%%%%%%%%%%%%%%%%%%%
%  New Commands  %
%%%%%%%%%%%%%%%%%%%


\newcommand{\ee}{\mathcal{E}}
\newcommand{\ii}{\mathbb{I}}
\newcommand{\rl}{\rangle\langle}
\newcommand{\mg}{\mathcal{G}}
\newcommand{\hn}[1]{\|#1\|^H_{1\rightarrow 1}}
\newcommand{\ve}[1]{|#1\rangle\!\rangle}
\newcommand{\ro}[1]{\langle\!\langle#1|}
\newcommand{\bkett}[1]{|#1\rangle\!\rangle\langle\!\langle#1|}
\newcommand{\ket}[1]{|#1\rangle}
\newcommand{\bra}[1]{\langle#1|}
\newcommand{\bk}[1]{|#1\rangle\langle#1|}
\newcommand{\tth}[0]{\textsuperscript{th}}
\newcommand{\st}[0]{\textsuperscript{st}}
\newcommand{\nd}[0]{\textsuperscript{nd}}
\newcommand{\rd}[0]{\textsuperscript{rd}}


\DeclareMathAlphabet{\matheu}{U}{eus}{m}{n}

\DeclareMathOperator{\tr}{tr}
\DeclareMathOperator{\id}{id}
\newcommand{\Favg}{\overline{F}}
\newcommand{\Paulis}{{\matheu P}}
\newcommand{\Clifs}{{\matheu C}}
\newcommand{\Hilb}{{\matheu H}}
\newcommand{\T}{{\matheu T}}
\newcommand{\sop}[1]{{\mathcal #1}}
\newcommand{\PL}[1]{{#1}^{P\!L}}
\newcommand{\BHn}{{{\mathcal B}({\mathcal H}^{\otimes n})}}
\newcommand{\I}{{\mathbb I}}
\newcommand{\CNOT}{{\mathrm{CNOT}}}
\newcommand{\plr}[1]{\hat{#1}} %pauli-liouville-represenation


%\newcommand{\ket}[1]{|{#1}\rangle}
%\newcommand{\bra}[1]{\langle{#1}|}
\newcommand{\braket}[2]{\langle{#1}|{#2}\rangle}
\newcommand{\ketbra}[2]{|{#1}\rangle\!\langle{#2}|}
\newcommand{\kket}[1]{|{#1}\rangle\!\rangle}
\newcommand{\bbra}[1]{\langle\!\langle{#1}|}
\newcommand{\bbrakket}[2]{\langle\!\langle{#1}|{#2}\rangle\!\rangle}
\newcommand{\proj}[1]{|#1\rangle\!\langle#1|}

\newcommand{\no}{\nonumber\\}

\newcommand{\ns}{{\textsc{ns}}}
\newcommand{\ceil}[1]{\left\lceil{#1}\right\rceil}
\newcommand{\se}{\succcurlyeq}
\newcommand{\di}{\textrm{diag}}
\newcommand{\capac}{c}
\newcommand{\eps}{\epsilon}

%-----------------------------------------------------------------------------%

%-- Graph Symbols --%
\newcommand{\depth}{d}
\newcommand{\subf}{l}
\newcommand{\edgeL}{\ell}
\newcommand{\Ohm}{c}
\newcommand{\norm}[1]{\left\| #1 \right\|}
\def\O{\mathrm{O}}
\def\tO{\widetilde{\mathrm{O}}}
\renewcommand{\th}[1]{${#1}^{\textrm{th}}$}
\begin{document}
\title{\large {\bf An approximate $\log n$ depth circuit for decoding waterfall states, with application to position based cryptography}}
\author{Alvaro Piedrafita, Subhasree Patro, Arjan Corneliessen, Farrokh Labib, Florian Speelman}
\maketitle


\input{section_setup.tex}


\section{Correctness of the circuit}
\input{CircuitUk.tikz}
Our goal here is to prove that the circuit from Figure \ref{fig:CircuitUk} extracts the value $x_k$ while leaving the state mostly unperturbed. That is, we will prove the following lemma.

\begin{lemma}
Let $\textbf{x}=(x_1,\dots,x_k)\in\{0,1\}^k$ be a $k$ bit string, and $\ket{\textbf{x}_{enc}}$ its encoding.
\begin{equation}
|\bra{\textbf{x}_{enc}}\bra{x_k}U_k\ket{\textbf{x}_{enc}}\ket{0}|= \sqrt{1-\frac{\sin^2\frac{\pi}{8}}{2^{k-1}}}
\end{equation}
\label{lem:bit_extract}
\end{lemma}
\begin{proof}
We begin by noticing that we can split $U_k$ into $V_k^\dagger CNOT_{(k,A)}V_k$, where $V_k$ are unitaries that only act on the block of $k$ qubits and the controlled not operation acts on the last qubit of the block and the ancilla. The crucial part of the proof will be to understand the structure of  $V_k\ket{Enc(\vec{x})}$. Indeed, allow us to write  $V_k\ket{Enc(\vec{x})}$ as
\[V_k\ket{\textbf{x}_{enc}}=\ket{\psi}\ket{x_k}+\ket{\phi}\ket{\bar{x_k}},\]
For some vectors $\ket{\psi}$ and $\ket{\phi}$. Observe that the $CNOT$ with a target initialized at $\ket{0}$ simply copies into the ancillary register the value of the $k$-th bit of $V_k\ket{\textbf{x}_{enc}}$, hence we have
\begin{equation}
CNOT_{(k,A)}V_k\ket{\textbf{x}_{enc}}\ket{0}=\ket{\psi}\ket{x_k}\ket{x_k}+\ket{\phi}\ket{\bar{x_k}}\ket{\bar{x_k}}.
\end{equation}

Hence, the inner product that we are interested in reads
\begin{eqnarray}
|\bra{\textbf{x}_{enc}}\bra{x_k}V_k^\dagger CNOT_{(k,A)}V_k\ket{\textbf{x}_{enc}}\ket{0}|&=&|\left[\left(\bra{\psi}\bra{x_k}+\bra{\phi}\bra{\bar{x_k}}\right)\bra{x_k}\right]\left[\ket{\psi}\ket{x_k}\ket{x_k}+\ket{\phi}\ket{\bar{x_k}}\ket{\bar{x_k}}\right]|\\
&=&|\braket{\psi}{\psi}|=\sqrt{1-|\braket{\phi}{\phi}|^2}.
\end{eqnarray}

Now, we shall characterize $V_k\ket{\textbf{x}_{enc}}$ and prove that $|\ket{\phi}|$ is really small.

We begin by observing that the action of $Y^{\frac{1}{4}}$ on $\ket{\textbf{x}_{enc}}$ only afects the first qubit, mapping it to

\[Y^\frac{1}{4}\ket{x_1}_{x_{0}}=(-1)^{x_0}\cos\frac{\pi}{8}\ket{x_1}+(-1)^{1-x_0}\sin\frac{\pi}{8}\ket{1-x_1}.\]
This last equality can be deduced directly from Figure \ref{fig:bases} because rotating $\ket{0}, \ket{1}, \ket{+},$ and $\ket{-}$ by an angle $\frac{\pi}{8}$ on the block sphere is conceptually nothing more than writing these states in the basis $\{\ket{\xi_0}, \ket{\xi_1}\}$ and rename those states as $\ket{0}$ and $\ket{1}$. Hence, we can think of this rotation as splitting $\ket{\textbf{x}_{enc}}$ into two parts, one with $\ket{x_1}$ in the first register, and one with $\ket{1-x_1}$ in the same register.

\begin{figure}[t]
\centering
\begin{tikzpicture}
\draw[black, thick,->] (0,0) -- (0,3) node[above] {$\ket{1}$};
\draw[black, thick,->] (0,0) --(3,0) node[right] {$\ket{0}$};
\draw[black, dashed,->] (0,0) --(2.1213,2.1213) node[above] {$\ket{+}$};
\draw[black, dashed,->] (0,0) --(-2.1213,2.1213) node[above] {$\ket{-}$};
\draw[black, dotted,->] (0,0) --(2.7716,1.14805) node[right] {$\ket{\xi_0}$};
\draw[black, dotted,->] (0,0) --(-1.14805,2.7716) node[above] {$\ket{\xi_1}$};
\end{tikzpicture}
\caption{The basis $\{\ket{\xi_0}, \ket{\xi_1}\}$.}
\label{fig:bases}
\end{figure}

When one applies the second layer of the circuit $V_k$ on part of the state $Y^{\frac{1}{4}}\ket{\textbf{x}_{enc}}$ labeled by $x_1$ in the first register, one obtains 
\[\cos\frac{\pi}{8}(-1)^{x_0}CH_{1,2}\ket{x_1}\bigotimes_{j=2}^k\ket{x_j}_{x_{j-1}}=\cos\frac{\pi}{8}(-1)^{x_0}\ket{x_1}H^{2 x_1}\ket{x_2}\bigotimes_{j=3}^k\ket{x_j}_{x_{j-1}}\]
In fact, it follows by inspection that the entire circuit $V_k$ acting on this state will simply decode the rest of the bits. More interesting is the action of that first controlled Hadamard on the other branch, $\sin\frac{\pi}{8}(-1)^{1-x_0}\ket{1-x_1}\bigotimes_{j=2}^k\ket{x_j}_{x_{j-1}}$. In this branch we have

\begin{eqnarray}
&CH(1,2)\ket{1-x_1}\ket{x_{2(x_1)}}\bigotimes_{j=3}^k\ket{x_j}_{x_{j-1}}\\
&=\ket{1-x_1}H^{(1-x_1)}H^{x_1}\ket{x_2}\bigotimes_{j=3}^k\ket{x_j}_{x_{j-1}}\\
&=\ket{1-x_1}\left(\frac{\ket{1-x_2}+(-1)^{x_2}\ket{x_2}}{\sqrt2}\right)\bigotimes_{j=3}^k\ket{x_j}_{x_{j-1}}
\end{eqnarray}

In general, for any given $l<k$, every time the controll qubit is in the wrong state, the controlled Hadamard will split the target into a ket with $\ket{x_l}$ and one with $\ket{1-x_l}$. Then again, the next controlled Hadamard will decode the next bit correctly on the first branch, and, in fact, the remainder of the circuit will correctly decode the rest of the qubits.Meanwile, on the wrong branch, the next gate will split the next qubit into an equal superposition of the correct and incorrect bit values, and the same argument will apply. It is a simple exercise that the state at the end of the circuit will be
\begin{equation}
V_k\ket{\textbf{x}_{enc}}=\cos\frac{\pi}{8}\bigotimes_{i=1}^k\ket{x_i}+\sin\frac{\pi}{8}\sum_{l=1}^k\frac{1}{2^{\frac{l-1}{2}}}\left(\bigotimes_{i=1}^l\ket{1-x_i}\bigotimes_{j=l+1}^k\ket{x_j}\right)
\end{equation}
Finally, notice how this state can be written as
\[V_k\ket{\textbf{x}_{enc}}=\ket{\psi}\ket{x_k}+\ket{\phi}\ket{1-x_k},\quad \text{where} \quad \ket{\phi}=\sin\frac{\pi}{8}\frac{1}{2^{\frac{k-1}{2}}}\bigotimes_{i=1}^{k-1}\ket{1-x_i}\]

\end{proof}

\input{CircuitDecoder.tikz}

Let us think about what this lemma for a second. What we have proved is that this little circuit does not just extract the value $x_k$ encoded in the last qubit of $\ket{\textbf{x}_{enc}}$ with very high probability, it actually does so while barley disturbing the state in the first $k-1$ qubits of the block. The next step is now dividing our $n$-qubit encoded state into $n/k$ blocks of size $k$ and run the circuit of Figure \ref{fig:CircuitUk} parallelly in each block. Now, if we run the honest decoder in each block with the first Hadamard of the circuit controlled on the ancilla of the previous block, we would find that the state is decoded almost exactly since the state in these qubits is very near the original encoded state and the state of that ancilla is very near the comutational basis state encoding the right bit of information. Refer to Figure \ref{fig:FullDecoder} for the entire decoding circuit.\\

For any particular block $B_i$, Lemma \ref{lem:bit_extract} implies that the amplitude of the ancilla on the state $\ket{x_{i_k}}$ will be  bigger than $ \sqrt{1-\frac{\sin^2\frac{\pi}{8}}{2^{k-1}}}$. Call this ancillary qubit $A_i$. At the same time, if we apply the same lemma to the block $B_{i+1}$, we would get that the state in the qubits of the block would have an overlap with $\ket{\textbf{x}^{(i+1)}_{enc}}$ which is also bigger than $ \sqrt{1-\frac{\sin^2\frac{\pi}{8}}{2^{k-1}}}$.\\

All this implies that if we take the state on the ancilla $A_i$ and the qubits of the block $B_{i+1}$, we would have amplitude at least $ \sqrt{1-\frac{\sin^2\frac{\pi}{8}}{2^{k-1}}}^2$ on the state $\ket{x_{i_k}}\ket{\textbf{x}^{(i+1)}_{enc}}$.\\

By construction, applying the waterfall circuit to the latter state will result in perfect decoding of the bits of block $B_{i+1}$. Hence, applying the whaterfall circuit to the output of the first stage to the ancilla $A_i$ and the qubits of the block $B_{i+1}$ will result in a state with an overlap bigger or equal than $\sqrt{1-\frac{\sin^2\frac{\pi}{8}}{2^{k-1}}}^2$ with the state $\ket{x_{i_k}}\ket{\textbf{x}^{(i+1)}}$ . Finally, observe that we can apply this waterfall circuit with depth $k$ to every block. The amplitude of the  joint state of all $n/k$ blocks in the state $\ket{\textbf{x}}$ will then be bigger than
\begin{equation}
 \left(1-\frac{\sin^2\frac{\pi}{8}}{2^{k-1}}\right)^{n/k}.
\end{equation}

Accordingly, the probability of obtaining the right string $(x_1,\dots,x_n)$ upon measuring the output state in the computational basis will be the square of that. Choosing the depth of the blocks to be $k=q\log n$ will result in a success probability of decoding of at least

\begin{equation}
 \left(1-\frac{\sin^2\frac{\pi}{8}}{2^{k-1}}\right)^{2n/k}=1-O\left(\frac{1}{qn^{q-1}\log n}\right)
\end{equation}


\end{document}